<?xml version="1.0" encoding="utf-8"?>
<feed xmlns="http://www.w3.org/2005/Atom">
    <title><![CDATA[timbroder.com]]></title>
    <link href="https://www.timbroder.com/blog/tags/php.xml" rel="self"/>
    <link href="https://www.timbroder.com/"/>
    <updated>2018-09-09T12:21:33+00:00</updated>
    <id>https://www.timbroder.com/</id>
            <author>
            <name><![CDATA[Tim Broder]]></name>            <email><![CDATA[timothy.broder@gmail.com]]></email>        </author>
        <generator uri="http://sculpin.io/">Sculpin</generator>
            <entry>
            <title type="html"><![CDATA[Setup and Teardown the Database Once Per Test Suite in PHPUnit]]></title>
            <link href="https://www.timbroder.com/2016/05/Setup-and-Teardown-the-Database-Once-Per-Test-Suite-with-PHPUnit-Listeners.html"/>
            <updated>2016-05-04T16:15:00+00:00</updated>
            <id>https://www.timbroder.com/2016/05/Setup-and-Teardown-the-Database-Once-Per-Test-Suite-with-PHPUnit-Listeners.html</id>
            <content type="html"><![CDATA[<p>I'm working on a series of integration tests where I want to set up and reset the database for each run. This could easily be done in the setUp and tearDown methods, but doing the full db each time is slow. Yes, I could just do the tables I need, but I was curious, and now I don't have to worry about which tables are setup in my testing DB. In this example, I'm using Laravel's migrations and SQLite as the test DB.</p>

<p><strong>UPDATE 05/05/2016</strong>: As Sebastian <a href="http://www.timbroder.com/2016/05/Setup-and-Teardown-the-Database-Once-Per-Test-Suite-with-PHPUnit-Listeners.html#comment-2659950789" title="point out below">points out below</a> (thanks!) there is a much more appropriate way. Using <code>setUpBeforeClass</code> and <code>tearDownAfterClass</code> we achieve the same effect</p>

<pre><code data-language="php">public static function setUpBeforeClass()
{
    parent::setUpBeforeClass();
    exec('php artisan migrate --database sqlite_test');
}

public static function tearDownAfterClass()
{
    exec('php artisan migrate:reset --database sqlite_test');
    parent::tearDownAfterClass(); 
}
</code></pre>

<p><del>PHPUnit has <a href="https://phpunit.de/manual/current/en/extending-phpunit.html#extending-phpunit.examples.SimpleTestListener.php" title="listeners">listeners</a> that you can tap into at various parts of your tests' lifecycle. I'm particularly interested in when a specific suite starts and ends. We'll need to do 2 things:</del></p>

<ol>
<li><del>Create our Listener</del></li>
<li><del>Register this Listener in phpunit.xml</del></li>
</ol>

<p>The listener is as follows:</p>

<pre><code data-language="php">class FullDBListener extends PHPUnit_Framework_BaseTestListener
{
    protected $suites = ['UserIntegrationTest', 'AccountIntegrationTest'];

    public function startTestSuite(PHPUnit_Framework_TestSuite $suite)
    {
        if (in_array($suite-&gt;getName(), $this-&gt;suites)) {
            exec('php artisan migrate --database sqlite_test');
        }
    }

    public function endTestSuite(PHPUnit_Framework_TestSuite $suite)
    {
        if (in_array($suite-&gt;getName(), $this-&gt;suites)) {
            exec('php artisan migrate:reset --database sqlite_test');
        }
    }
}
</code></pre>

<p>This does a few things:</p>

<ol>
<li><del>Stores the class names of each suite we want to run the db migrations for</del></li>
<li><del>In <code>startTestSuite</code> it checks to see if we're in the right suite</del></li>
<li><del>If we are, run an artisan migration on our test db</del></li>
<li><del>In <code>endTestSuite</code> it checks to see if we're in the right suite</del></li>
<li><del>If we are, run an artisan migration:reset on our test db</del></li>
</ol>

<p><del>Next, we need to make PHPUnit aware of this listener. Update your path accordingly</del></p>

<pre><code data-language="xml">&lt;listeners&gt;
    &lt;listener class="FullDBListener" file="./tests/app/FullDBListener.php"&gt;&lt;/listener&gt;
&lt;/listeners&gt;
</code></pre>

<p>That's it!</p>

<p>I do do some basic teardown in my test suite's <code>setUp</code> method to give me a blank slate. This has proven faster then doing the migrations each time</p>

<pre><code data-language="php">public function setUp()
{
    parent::setUp();

    User::truncate();
}
</code></pre>

<p>I hope this helped you, if you have any questions, let me know!</p>
]]></content>
        </entry>
            <entry>
            <title type="html"><![CDATA[PHP7 Vagrant Box]]></title>
            <link href="https://www.timbroder.com/2015/03/php7-vagrant-box.html"/>
            <updated>2015-03-07T16:13:24+00:00</updated>
            <id>https://www.timbroder.com/2015/03/php7-vagrant-box.html</id>
            <content type="html"><![CDATA[<p>I’m keeping a close eye (or as much as I can anyway) on PHP7 and what it means
for the future of the language. Installing in your local dev machine is risky,
especially if you have ongoing work. As usual, Vagrant comes to the rescue!</p>

<p><a href="https://twitter.com/rasmus/">Rasmus Lerdorf</a> has put together a Vagrant box
to ease in the setup and isolate your testing.</p>

<p>If you use Atlas, check out the box
<a href="https://atlas.hashicorp.com/rasmus/boxes/php7dev">here</a>. Otherwise, the
readme is available on
<a href="https://github.com/rlerdorf/php7dev/blob/master/README.md">Github</a></p>
]]></content>
        </entry>
            <entry>
            <title type="html"><![CDATA[Fixing YouTube embeds in Wordpress]]></title>
            <link href="https://www.timbroder.com/2013/05/fixing-youtube-embeds-in-wordpress.html"/>
            <updated>2013-05-10T16:42:32+00:00</updated>
            <id>https://www.timbroder.com/2013/05/fixing-youtube-embeds-in-wordpress.html</id>
            <content type="html"><![CDATA[<p>In some wordpress themes, youtube embeds just show up as a black screen. As
discussed <a href="http://wordpress.org/support/topic/dynamically-change-youtube-iframe-embeds-to-auto-add-transparent-mode?replies=8">here</a>, the solution is
adding a transparency setting to the iframe's src.</p>

<p>However, the solution in
that thread only works if the src is right next to the frameborder. Updated
code below if you are running into this problem</p>

<pre><code data-language="PHP">function add_video_wmode_transparent( $html ) {
    $pattern = '#(src=&amp;quot;https?://www.youtube(?:-nocookie)?.com/(?:v|embed)/([a-zA-Z0-9-]+).&amp;quot;)#';
    preg_match_all( $pattern, $html, $matches );

    if ( count( $matches ) &amp;gt; 0) {
        foreach ( $matches[0] as $orig_src ) {
            if ( !strstr($orig_src, 'wmode=transparent' ) &amp;amp;&amp;amp; !strstr( $orig_src, 'hd=1' ) ) {
                $add = 'hd=1&amp;amp;wmode=transparent&amp;quot;';

                if ( !strstr($orig_src, '?') ) {
                    $add = '?' . $add;
                }
                $new_src = substr( $orig_src, 0, -1 ) . $add;
                $html = str_replace( $orig_src, $new_src, $html );
            }
        }
    }
    return $html;
}
add_filter( 'the_content', 'add_video_wmode_transparent', 10 );
</code></pre>

<p>New thread in the wordpress forums can be found
<a href="htp://wordpress.org/support/topic/dynamically-change-youtube-iframe-embeds-to-auto-add-transparent-mode-updated">here</a>. (The original was closed)</p>
]]></content>
        </entry>
            <entry>
            <title type="html"><![CDATA[How to Remove or Change the way Wordpress Links to Images in Posts]]></title>
            <link href="https://www.timbroder.com/2012/12/how-to-remove-or-change-the-way-wordpress-links-to-images-in-posts.html"/>
            <updated>2012-12-24T20:34:43+00:00</updated>
            <id>https://www.timbroder.com/2012/12/how-to-remove-or-change-the-way-wordpress-links-to-images-in-posts.html</id>
            <content type="html"><![CDATA[<p>By default, WordPress will link directly to an image in the category or post view.  In a project I was working on today I wanted to change that. On the category view I wanted the image just to link to the post, and in the post, I didn’t want a link at all. Useful trick I found below:</p>

<pre><code data-language="PHP">function change_image_permalink($content){
    $format = get_post_format();

    //category listing page. link image to post
    if (is_single() === FALSE AND $format == 'image'){
        $content =
        preg_replace(
            array('{&lt;a(.*?)(wp-att|wp-content/uploads)[^&gt;]*&gt;&lt;img}','{ wp-image-[0-9]*&amp;quot; /&gt;&lt;/a&gt;}'),
            array('&lt;a href=&amp;quot;' . get_permalink() . '&amp;quot;&gt;&lt;img','&amp;quot; /&gt;&lt;/a&gt;'),
            $content
        );
    }

    //post page. remove link
    else if ($format == 'image'){
        $content =
            preg_replace(
                array('{&lt;a(.*?)(wp-att|wp-content/uploads)[^&gt;]*&gt;&lt;img}','{ wp-image-[0-9]*&amp;quot; /&gt;&lt;/a&gt;}'),
                array('&lt;img','&amp;quot; /&gt;'),
                $content
            );
    }

    return $content;
}
add_filter('the_content', 'change_image_permalink');
</code></pre>
]]></content>
        </entry>
            <entry>
            <title type="html"><![CDATA[Important Magento Security Update – Zend Platform Vulnerability]]></title>
            <link href="https://www.timbroder.com/2012/07/important-magento-security-update-zend-platform-vulnerability.html"/>
            <updated>2012-07-06T18:47:04+00:00</updated>
            <id>https://www.timbroder.com/2012/07/important-magento-security-update-zend-platform-vulnerability.html</id>
            <content type="html"><![CDATA[<p>While doing routine sanity checks, on of our QA Engineers, Sammy Shaar, was
alerted about an important Magento <a href="http://by.ai/MnzJ">security update</a>. The
vulnerability potentially allows an attacker to read any file on the web
server where the <a href="http://by.ai/rk3s">Zend XMLRPC</a> functionality is enabled.
This might include password files, configuration files, and possibly even
databases if they are stored on the same machine as the Magento web server. To
see if you site has been affected, please see <a href="http://by.ai/CpYr">this page</a>.
Luckily, Magento has released patches for all supported versions:</p>

<ul>
<li>Magento Enterprise Edition and Professional Edition merchants: You may access the Zend Security Upgrade patch from Patches &amp; Support for your product in the Downloads section of your Magento account. Account log-in is required.<a href="http://www.magentocommerce.com/products/customer/account/" title="Download"> Download</a></li>
<li>Magento Community Edition merchants:<a href="http://www.magentocommerce.com/downloads/assets/1.7.0.2/CE_1.4.0.0-1.4.1.1.patch" title="Community Edition 1.4.0.0 through 1.4.1.1"> Community Edition 1.4.0.0 through 1.4.1.1</a><a href="http://www.magentocommerce.com/downloads/assets/1.7.0.2/CE_1.4.2.0.patch" title="Community Edition 1.4.2.0"> Community Edition 1.4.2.0</a><a href="http://www.magentocommerce.com/downloads/assets/1.7.0.2/CE_1.5.0.0-1.7.0.1.patch" title="Community Edition 1.5.0.0 through 1.7.0.1"> Community Edition 1.5.0.0 through 1.7.0.1</a>
To install the patch, place the patch file in the root of your Magento site
and run the following command: patch -p0 &lt; zendxml_fix.patch If you don't
have ssh access or patch installed on your machine, please see this stack
overflow <a href="http://by.ai/1LtK">post </a>for alternative methods.</li>
</ul>
]]></content>
        </entry>
            <entry>
            <title type="html"><![CDATA[Creating a stateless request in Magento]]></title>
            <link href="https://www.timbroder.com/2011/10/1060.html"/>
            <updated>2011-10-17T16:22:06+00:00</updated>
            <id>https://www.timbroder.com/2011/10/1060.html</id>
            <content type="html"><![CDATA[<p>Have you ever wanted to create a stateless request in Magento? Something that doesn't touch any of Magento's sessions?  We were having issues with some of the ajax calls on our cart and checkout pages mucking with the user's cart and had get stateless on these calls.  The issue we were having was our checkout page was loading, then a javascript include was going out and bringing code from a 3rd party relevance engine into our dom, which was in turn calling back an ajax request to our servers.  This issue with this being that at the start of the page load, the checkout session was being set to a certain state.  This state was then being sent through the rest of the page load, and the ajax calls. Unfortunately, by the time the ajax call got back to our server, the session was different in both locations, creating a race condition.  The ajax request usually won, removing the work the full page load had done with trying to process checkout.  The good news was there was nothing in the ajax call that needed to touch the session, it was just some data lookup. So, nix the session part of that call, and our troubles should be over... Magento's api controller is the only place that implements a stateless request this but its fairly easy to do (after a bit of digging).</p>

<p>As long as Mage_Core_Controller_Varien_Action is a parent in your controller's hierchy, you are good to go (it probably is).  This class has a const FLAG_NO_START_SESSION which looks promising. Digging into the code a little we see that it controls whether cookies are processed or the session is started:</p>

<pre><code data-language="PHP">&lt;?php
...
        if (!$this-&gt;getFlag('', self::FLAG_NO_START_SESSION)) {
            $checkCookie = in_array($this-&gt;getRequest()-&gt;getActionName(), $this-&gt;_cookieCheckActions);
            $checkCookie = $checkCookie &amp;amp;&amp;amp; !$this-&gt;getRequest()-&gt;getParam('nocookie', false);
            $cookies = Mage::getSingleton('core/cookie')-&gt;get();
            if ($checkCookie &amp;amp;&amp;amp; empty($cookies)) {
                $this-&gt;setFlag('', self::FLAG_NO_COOKIES_REDIRECT, true);
            }
            Mage::getSingleton('core/session', array('name' =&gt; $this-&gt;_sessionNamespace))-&gt;start();
        }
</code></pre>

<p>By adding to the preDispatch() method of our Action or Controller we can toggle this:</p>

<pre><code data-language="PHP">&lt;?php
class Ai_AjaxCatalog_Controller_Action extends Mage_Core_Controller_Front_Action
{
    public function preDispatch()
    {
        $this-&gt;setFlag('', self::FLAG_NO_START_SESSION, 1); // Do not start standard session
        parent::preDispatch();
        return $this;
    }
}
</code></pre>

<p>Now, any action in this controller will be stateless and not effect any sessions.</p>
]]></content>
        </entry>
            <entry>
            <title type="html"><![CDATA[Extending a Magento Controller]]></title>
            <link href="https://www.timbroder.com/2011/04/extending-a-magento-controller.html"/>
            <updated>2011-04-19T21:16:46+00:00</updated>
            <id>https://www.timbroder.com/2011/04/extending-a-magento-controller.html</id>
            <content type="html"><![CDATA[<p>We're ajaxing part of the Magento shopping cart so we need to modify/extend some of the cart controller functionality.  Sometimes when modifying controller's you have to worry about updating the routes. For this, we don't need to, we still want all the urls to be used the same way.</p>

<p>app/code/local/Ai/Checkout/etc/config.xml:</p>

<pre><code data-language="XML">&lt;config&gt;
    &lt;modules&gt;
        &lt;Ai_Checkout&gt;
             &lt;version&gt;0.0.1&lt;/version&gt;
        &lt;/Ai_Checkout&gt;
    &lt;/modules&gt;
...
    &lt;frontend&gt;
        &lt;routers&gt;
            &lt;checkout&gt;
                &lt;use&gt;standard&lt;/use&gt;
                &lt;args&gt;
                    &lt;module&gt;Ai_Checkout&lt;/module&gt;
                    &lt;frontName&gt;checkout&lt;/frontName&gt;
                &lt;/args&gt;
            &lt;/checkout&gt;
        &lt;/routers&gt;
    &lt;/frontend&gt;    
&lt;/config&gt;
</code></pre>

<p>app/code/local/Ai/Checkout/controllers/CartController.php:</p>

<p>```PHP
require_once Mage::getModuleDir('controllers', 'Mage_Checkout') . DS . 'CartController.php';</p>

<p>class Ai_Checkout_CartController extends Mage_Checkout_CartController
{
   public function updatePostAction()
    {
        Mage::log(&quot;NEW CONTROLLER&quot;, null, 'tim.log');
        try {
[/php]</p>
]]></content>
        </entry>
            <entry>
            <title type="html"><![CDATA[A note on Magento and multiple nodes using Memcached]]></title>
            <link href="https://www.timbroder.com/2011/02/a-note-on-magento-and-multiple-nodes-using-memcached.html"/>
            <updated>2011-02-11T18:35:44+00:00</updated>
            <id>https://www.timbroder.com/2011/02/a-note-on-magento-and-multiple-nodes-using-memcached.html</id>
            <content type="html"><![CDATA[<p>If you have multiple nodes using a shared memcached server, make sure you
define a shared prefix for the keys to use.</p>

<p>In local.xml:</p>

<pre><code data-language="XML">        &lt;cache&gt;
...
            &lt;prefix&gt;a1i&lt;/prefix&gt;
            &lt;id_prefix&gt;a1i&lt;/id_prefix&gt;
            &lt;memcached&gt;
...
</code></pre>
]]></content>
        </entry>
            <entry>
            <title type="html"><![CDATA[Want to output the full xml config Magento is running?]]></title>
            <link href="https://www.timbroder.com/2011/01/want-to-output-the-full-xml-config-magento-is-running.html"/>
            <updated>2011-01-27T19:56:14+00:00</updated>
            <id>https://www.timbroder.com/2011/01/want-to-output-the-full-xml-config-magento-is-running.html</id>
            <content type="html"><![CDATA[<pre><code data-language="PHP">Mage::getConfig()-&amp;gt;getNode()-&amp;gt;asNiceXml('full_config.xml');
</code></pre>

<p>Where full_config.xml is the file you want it dumped to.</p>
]]></content>
        </entry>
            <entry>
            <title type="html"><![CDATA[Want to trace the call stack in Magento?]]></title>
            <link href="https://www.timbroder.com/2011/01/want-to-trace-the-call-stack-in-magento.html"/>
            <updated>2011-01-04T21:35:38+00:00</updated>
            <id>https://www.timbroder.com/2011/01/want-to-trace-the-call-stack-in-magento.html</id>
            <content type="html"><![CDATA[<p>Update: This code is also available on <a href="https://github.com/broderboy/magento-callstack" title="Github">Github</a> as a Mageno module</p>

<p>This has helped me immensely in situations like "Where is this getting called from??!?"</p>

<p>Create a helper like so:</p>

<pre><code data-language="PHP">class Timbroder_Stack_Helper_Callstack extends Mage_Core_Helper_Abstract
{
    private function get_callstack($delim=&amp;quot;\n&amp;quot;) {
      $dt = debug_backtrace();
      $cs = '';
      foreach ($dt as $t) {
        $cs .= $t['file'] . ' line ' . $t['line'] . ' calls ' . $t['function'] . &amp;quot;()&amp;quot; . $delim;
      }

      return $cs;
    }

    public function toLog() {
        Mage::log($this-&amp;gt;get_callstack());
    }

    public function toFirePhp() {
        $stack = $this-&amp;gt;get_callstack();
        foreach (explode(&amp;quot;\n&amp;quot;, $stack) as $line) {
            Mage::helper('firephp')-&amp;gt;send($line);
        }
    }
}
</code></pre>

<p>That can be called from anywhere:</p>

<p>``PHP
Mage::helper('stack/callstack')-&gt;toFirePhp();
Mage::helper('stack/callstack')-&gt;toLog();</p>

<pre><code><br />I've also wrapped this into a module that you can drop right into your project.  Details here: [https://bitbucket.org/broderboy/magento_callstack/src](https://bitbucket.org/broderboy/magento_callstack/src "https://bitbucket.org/broderboy/magento_callstack/src")

Example output:

</code></pre>

<p>.../app/code/community/Timbroder/Stack/Helper/Callstack.php line 16 calls get_callstack()
.../app/design/frontend/mongoose/default/template/catalog/cms/bikes_bmx.phtml line 12 calls toLog()
.../app/design/frontend/mongoose/default/template/catalog/cms/bikes.phtml line 21 calls require_once()
.../app/code/core/Mage/Core/Block/Template.php line 212 calls include()
.../app/code/core/Mage/Core/Block/Template.php line 239 calls fetchView()
.../app/code/core/Mage/Core/Block/Template.php line 253 calls renderView()
.../app/code/core/Mage/Core/Block/Abstract.php line 668 calls _toHtml()
.../app/code/core/Mage/Core/Model/Email/Template/Filter.php line 190 calls toHtml()
.../lib/Varien/Filter/Template.php line 134 calls call_user_func()
.../app/code/core/Mage/Core/Model/Email/Template/Filter.php line 501 calls filter()
.../app/code/core/Mage/Cms/Block/Page.php line 100 calls filter()
.../app/code/core/Mage/Core/Block/Abstract.php line 668 calls _toHtml()
.../app/code/core/Mage/Core/Block/Abstract.php line 513 calls toHtml()
.../app/code/core/Mage/Core/Block/Abstract.php line 460 calls _getChildHtml()
.../app/code/local/Mage/Page/Block/Html/Wrapper.php line 52 calls getChildHtml()
.../app/code/core/Mage/Core/Block/Abstract.php line 668 calls _toHtml()
.../app/code/core/Mage/Core/Block/Text/List.php line 43 calls toHtml()
.../app/code/core/Mage/Core/Block/Abstract.php line 668 calls _toHtml()
.../app/code/core/Mage/Core/Block/Abstract.php line 513 calls toHtml()
.../app/code/core/Mage/Core/Block/Abstract.php line 464 calls _getChildHtml()
.../app/design/frontend/mongoose/default/template/page/1column.phtml line 55 calls getChildHtml()
.../app/code/core/Mage/Core/Block/Template.php line 212 calls include()
.../app/code/core/Mage/Core/Block/Template.php line 239 calls fetchView()
.../app/code/core/Mage/Core/Block/Template.php line 253 calls renderView()
.../app/code/core/Mage/Core/Block/Abstract.php line 668 calls _toHtml()
.../app/code/core/Mage/Core/Model/Layout.php line 529 calls toHtml()
.../app/code/local/Mage/Core/Controller/Varien/Action.php line 389 calls getOutput()
.../app/code/core/Mage/Cms/Helper/Page.php line 130 calls renderLayout()
.../app/code/core/Mage/Cms/Helper/Page.php line 52 calls _renderPage()
.../app/code/core/Mage/Cms/controllers/PageController.php line 45 calls renderPage()
.../app/code/local/Mage/Core/Controller/Varien/Action.php line 418 calls viewAction()
.../app/code/core/Mage/Core/Controller/Varien/Router/Standard.php line 254 calls dispatch()
.../app/code/core/Mage/Core/Controller/Varien/Front.php line 177 calls match()
.../app/code/core/Mage/Core/Model/App.php line 304 calls dispatch()
.../app/Mage.php line 598 calls run()
.../index.php line 155 calls run()
```</p>

<p>Thanks to <a href="http://www.nextide.ca/node/518">nextide</a> for some of the code</p>
]]></content>
        </entry>
    </feed>